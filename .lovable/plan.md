
Цель: устранить ситуацию в Telegram Mini App на iOS (два iPhone), когда у инициатора после нажатия “Разрешить микрофон” окно звонка исчезает (иногда возвращается позже), хотя у собеседника входящий звонок отображается и звонок “идёт”.

## Что я вижу по текущему коду
- `GlobalCallOverlay` показывает UI только когда:
  - входящий звонок: `incomingCall && status === "idle"`
  - активный звонок: `status !== "idle"`
- То есть, если по какой-то причине `status` возвращается в `"idle"` в момент/сразу после permission prompt — UI пропадает.
- В текущем `VideoCallContext.tsx` нет “UI-lock” флага (хотя ранее это обсуждалось). Значит, UI полностью зависит от `status`.
- На iOS WebView/Telegram Mini App разрешение микрофона может:
  - вызвать короткий жизненный цикл “page hide/show” или ре-инициализацию JS,
  - “потрясти” layout/viewport (visualViewport) так, что fixed-оверлеи могут исчезать/мигать,
  - на практике часто требует отдельной стабилизации UI во время permission prompt.

## Гипотезы причины (ранжирование по вероятности)
1) **Сброс состояния в `idle` из-за какого-то “cleanup”/ошибки во время инициализации** (например, цепочка: `getUserMedia` → дальше ошибка в `createPeerConnection`/signaling → catch → `cleanup()` → `status="idle"`). При этом запись `video_calls` уже могла создаться — поэтому “у друга звонок идёт”, а у инициатора UI исчез.
2) **Telegram iOS WebView кратковременно “пересоздаёт” контекст/видимость** после разрешения микрофона; из-за этого “логика отображения” должна переживать такие события (держать UI активным независимо от `status` некоторое время/до явного завершения).
3) **UI технически остаётся в DOM, но становится невидимым/перекрытым** из‑за особенностей fixed внутри контейнеров/трансформов/viewport. Это лечится рендером через Portal в `document.body` + повышением стабильности стилей.

## Что сделаю (изменения в коде)
### 1) Добавить “UI-lock” в `VideoCallContext` (ключевое)
Добавим в контекст:
- `isCallUiActive: boolean`
- `setCallUiActive` будет управляться строго действиями пользователя и явным завершением звонка, а не “мимолётными” изменениями `status`.

Логика:
- При `startCall(...)`:
  - сразу `setIsCallUiActive(true)` **до** `getUserMedia()`
  - затем вызываем `startVideoCall(...)`
  - если `startVideoCall` вернул `null` (ошибка) — тогда `setIsCallUiActive(false)` и покажем понятное сообщение (toast/лог).
- При `answerCall(call)`:
  - `setIsCallUiActive(true)` до `getUserMedia()`
  - дальше как сейчас.
- При `declineCall` / `endCall` / `onCallEnded`:
  - `setIsCallUiActive(false)`.

Почему это важно: даже если `status` на долю секунды станет `idle` во время permission prompt/переподключений, UI останется.

### 2) Изменить условие рендера в `GlobalCallOverlay`
Сделаем правило:
- Показать `VideoCallScreen`, если:
  - `isCallUiActive === true` **ИЛИ** `status !== "idle"`

Показать `IncomingVideoCallSheet`:
- как сейчас, но также **не показывать** его если `isCallUiActive` уже true (чтобы не было “мигания” между экранами).

### 3) Рендерить оверлей через Portal в `document.body` (стабильность iOS WebView)
Обновим `GlobalCallOverlay` так, чтобы `IncomingVideoCallSheet` и `VideoCallScreen` рендерились через `createPortal(..., document.body)`.
Это часто решает проблемы iOS/Telegram WebView, когда fixed/оверлеи “мигают” из-за контекстов/overflow/transform у родителей.

### 4) Добавить защиту от “авто-cleanup при pagehide/visibilitychange” (точечно)
В `useVideoCall.ts` добавим обработчики:
- `document.visibilitychange`
- `pagehide` / `pageshow`

Идея:
- если мы в активном процессе звонка (например `status !== "idle"` или “UI-lock активен”), то на `pagehide` **не** вызывать `cleanup()` автоматически (либо откладывать cleanup на несколько секунд и отменять, если страница быстро вернулась).
- при `pageshow`/`visibilitychange` обратно — логируем и продолжаем.

Это важно именно для Telegram Mini App, где разрешения/системные UI могут дёргать видимость.

### 5) Улучшить диагностику: понять, кто сбрасывает статус в idle
Добавим структурные логи (и/или toast в dev):
- В `useVideoCall.startCall`:
  - лог до `getUserMedia`
  - лог после `getUserMedia` (успех)
  - лог после insert `video_calls`
  - лог после `setupBroadcastChannel`, после `createPeerConnection`
- В `cleanup()`:
  - лог с причиной (добавим параметр `cleanup(reason)`), чтобы видеть, что именно привело к сбросу.
- В `GlobalCallOverlay`:
  - логируем `status`, `isCallUiActive`, `hasCurrentCall`.

Это позволит точно подтвердить, что “исчезновение UI” = `status->idle`, а не CSS.

### 6) (Опционально, но рекомендую для Telegram) “предварительное разрешение микрофона” по пользовательскому действию
Чтобы permission prompt не происходил в момент звонка:
- добавим кнопку/действие “Разрешить микрофон” (или автоматически при первом открытии чатов/первом нажатии на кнопку звонка, но до создания вызова):
  - вызвать `getUserMedia({ audio: true, video: false })`
  - сразу остановить треки
  - сохранить флаг `micPermissionGranted=true` (в памяти/локально)
- затем при старте звонка вероятность “перезапуска WebView” снижается, и UI не будет “мигать” в самый критичный момент.

Важно: на iOS запрос разрешений обычно должен идти от явного действия пользователя (tap). Мы впишем это в UX.

## Проверка результата (что вы сможете проверить)
1) Инициатор: нажимает “Позвонить” → появляется экран звонка → нажимает “Разрешить микрофон” → экран **не исчезает**.
2) Входящий у собеседника: окно “Принять/Отклонить” не мигает, после “Принять” переход в экран звонка стабильный.
3) В логах:
   - нет неожиданных `cleanup(reason=...)` сразу после `getUserMedia success`.

## Риски / edge cases
- Если Telegram WebView реально перезагружает страницу (полный reload), UI-lock в памяти не поможет. Тогда потребуется “восстановление активного звонка” из базы (читать последние активные `video_calls` для пользователя и пытаться реинициализировать соединение). Это более сложный этап, но я могу сделать, если подтвердим, что происходит именно reload.
- Portal может потребовать небольших правок по z-index, но обычно он только улучшает ситуацию.

## Что мне от вас нужно (минимально)
После внедрения:
- короткое видео/скринкаст экрана инициатора: “Позвонить → Разрешить микрофон → что происходит”
- если сможете: скопировать 15–30 строк логов, где видно `cleanup(...)` и переход `status`.

